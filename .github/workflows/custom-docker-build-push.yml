name: custom-docker-build-push

on:
  workflow_dispatch:
    inputs:
      Override_Registry_Base_URL:
        type: string
      Override_Registry_Username:
        type: string
      Override_Registry_Password:
        type: string
      Override_Registry_Namespace:
        type: string
      Override_Image_Tag:
        type: string
      Override_Repo_Name:
        type: string
      Override_Dockerfile:
        type: string
      Override_Code_Path:
        type: string
      Use_Build_Cache:
        type: boolean
        default: true

permissions:
  contents: read
  packages: write

env:
  Registry_Base_URL: ${{ inputs.Override_Registry_Base_URL || vars.REGISTRY_BASE_URL || 'ghcr.io' }}
  Registry_Namespace: ${{ inputs.Override_Registry_Namespace || vars.REGISTRY_NAMESPACE || github.repository_owner }}
  Image_Tag: ${{ inputs.Override_Image_Tag || github.ref_name }}
  Repo_Name: ${{ inputs.Override_Repo_Name || 'bot-orchestrator' }}
  Dockerfile: ${{ inputs.Override_Dockerfile || 'community-edition/services/bot-orchestrator/Dockerfile' }}
  Code_Path: ${{ inputs.Override_Code_Path || 'community-edition/services/bot-orchestrator' }}
  Use_Build_Cache: ${{ inputs.Use_Build_Cache }}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Assign username from secret
        if: ${{ inputs.Override_Registry_Username == '' }}
        run: |
          USERNAME="${{ secrets.REGISTRY_USERNAME }}"
          if [ -z "$USERNAME" ]; then
            USERNAME="${{ github.actor }}"
          fi
          echo "Registry_Username=$USERNAME" >> "$GITHUB_ENV"

      - name: Assign username from input
        if: ${{ inputs.Override_Registry_Username != '' }}
        run: |
          USERNAME=$(jq -r '.inputs.Override_Registry_Username' "$GITHUB_EVENT_PATH")
          echo "::add-mask::$USERNAME"
          echo "Registry_Username=$USERNAME" >> "$GITHUB_ENV"

      - name: Assign password from secret
        if: ${{ inputs.Override_Registry_Password == '' }}
        run: |
          PASSWORD="${{ secrets.REGISTRY_PASSWORD }}"
          if [ -z "$PASSWORD" ]; then
            PASSWORD="${{ secrets.GITHUB_TOKEN }}"
          fi
          echo "Registry_Password=$PASSWORD" >> "$GITHUB_ENV"

      - name: Assign password from input
        if: ${{ inputs.Override_Registry_Password != '' }}
        run: |
          PASSWORD=$(jq -r '.inputs.Override_Registry_Password' "$GITHUB_EVENT_PATH")
          echo "::add-mask::$PASSWORD"
          echo "Registry_Password=$PASSWORD" >> "$GITHUB_ENV"

      - name: Sanitize image tag
        run: |
          TAG="${{ env.Image_Tag }}"
          TAG="${TAG//\//-}"
          echo "Image_Tag=$TAG" >> "$GITHUB_ENV"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: "./repo"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.Registry_Base_URL }}
          username: ${{ env.Registry_Username }}
          password: ${{ env.Registry_Password }}

      - name: Docker Build and Push (with cache)
        if: ${{ fromJSON(env.Use_Build_Cache) == true }}
        uses: docker/build-push-action@v6
        with:
          context: repo/${{ env.Code_Path }}
          file: repo/${{ env.Dockerfile }}
          tags: ${{ env.Registry_Base_URL }}/${{ env.Registry_Namespace }}/${{ env.Repo_Name }}:${{ env.Image_Tag }}-latest,${{ env.Registry_Base_URL }}/${{ env.Registry_Namespace }}/${{ env.Repo_Name }}:${{ env.Image_Tag }}-${{ github.run_number }}
          cache-from: type=registry,ref=${{ env.Registry_Base_URL }}/${{ env.Registry_Namespace }}/${{ env.Repo_Name }}:buildcache
          cache-to: type=registry,ref=${{ env.Registry_Base_URL }}/${{ env.Registry_Namespace }}/${{ env.Repo_Name }}:buildcache,mode=max,image-manifest=true,oci-mediatypes=true
          push: true

      - name: Docker Build and Push (no cache)
        if: ${{ fromJSON(env.Use_Build_Cache) == false }}
        uses: docker/build-push-action@v6
        with:
          context: repo/${{ env.Code_Path }}
          file: repo/${{ env.Dockerfile }}
          tags: ${{ env.Registry_Base_URL }}/${{ env.Registry_Namespace }}/${{ env.Repo_Name }}:${{ env.Image_Tag }}-latest,${{ env.Registry_Base_URL }}/${{ env.Registry_Namespace }}/${{ env.Repo_Name }}:${{ env.Image_Tag }}-${{ github.run_number }}
          push: true
